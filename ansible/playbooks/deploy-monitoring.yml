---
- name: Deploy Monitoring Stack (Prometheus + Grafana)
  hosts: tag_Role_monitoring
  become: yes
  gather_facts: no

  vars:
    monitoring_dir: /home/ubuntu/monitoring
    grafana_admin_password: "{{ lookup('env', 'GRAFANA_ADMIN_PASSWORD') | default('admin', true) }}"
    prometheus_version: "latest"
    grafana_version: "latest"
    node_exporter_version: "latest"

  tasks:
    - name: Create monitoring directories
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        owner: ubuntu
        group: ubuntu
        mode: '0755'
      loop:
        - "{{ monitoring_dir }}"
        - "{{ monitoring_dir }}/prometheus"
        - "{{ monitoring_dir }}/grafana/provisioning/datasources"
        - "{{ monitoring_dir }}/grafana/provisioning/dashboards"
        - "{{ monitoring_dir }}/grafana/dashboards"

    - name: Copy Prometheus configuration
      ansible.builtin.copy:
        src: ../files/prometheus.yml
        dest: "{{ monitoring_dir }}/prometheus/prometheus.yml"
        owner: ubuntu
        group: ubuntu
        mode: '0644'

    - name: Copy Grafana datasource provisioning
      ansible.builtin.copy:
        src: ../files/grafana/provisioning/datasources/datasources.yml
        dest: "{{ monitoring_dir }}/grafana/provisioning/datasources/datasources.yml"
        owner: ubuntu
        group: ubuntu
        mode: '0644'

    - name: Copy Grafana dashboard provisioning config
      ansible.builtin.copy:
        src: ../files/grafana/provisioning/dashboards/dashboards.yml
        dest: "{{ monitoring_dir }}/grafana/provisioning/dashboards/dashboards.yml"
        owner: ubuntu
        group: ubuntu
        mode: '0644'

    - name: Copy Grafana dashboard JSON
      ansible.builtin.copy:
        src: ../files/grafana/dashboards/node-exporter.json
        dest: "{{ monitoring_dir }}/grafana/dashboards/node-exporter.json"
        owner: ubuntu
        group: ubuntu
        mode: '0644'

    - name: Create docker-compose for monitoring stack
      ansible.builtin.copy:
        content: |
          services:
            prometheus:
              image: prom/prometheus:{{ prometheus_version }}
              container_name: prometheus
              restart: unless-stopped
              ports:
                - "9090:9090"
              volumes:
                - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
                - prometheus_data:/prometheus
              command:
                - '--config.file=/etc/prometheus/prometheus.yml'
                - '--storage.tsdb.path=/prometheus'
                - '--web.enable-lifecycle'

            grafana:
              image: grafana/grafana:{{ grafana_version }}
              container_name: grafana
              restart: unless-stopped
              ports:
                - "3000:3000"
              volumes:
                - grafana_data:/var/lib/grafana
                - ./grafana/provisioning:/etc/grafana/provisioning:ro
                - ./grafana/dashboards:/var/lib/grafana/dashboards:ro
              environment:
                - GF_SECURITY_ADMIN_USER=admin
                - GF_SECURITY_ADMIN_PASSWORD={{ grafana_admin_password }}
                - GF_USERS_ALLOW_SIGN_UP=false
              depends_on:
                - prometheus

            node-exporter:
              image: prom/node-exporter:{{ node_exporter_version }}
              container_name: node-exporter
              restart: unless-stopped
              ports:
                - "9100:9100"
              volumes:
                - /proc:/host/proc:ro
                - /sys:/host/sys:ro
                - /:/rootfs:ro
              command:
                - '--path.procfs=/host/proc'
                - '--path.sysfs=/host/sys'
                - '--path.rootfs=/rootfs'
                - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)'

          volumes:
            prometheus_data:
            grafana_data:
        dest: "{{ monitoring_dir }}/docker-compose.yml"
        owner: ubuntu
        group: ubuntu
        mode: '0644'

    - name: Deploy Monitoring Stack
      ansible.builtin.shell: |
        cd {{ monitoring_dir }}
        docker compose down --remove-orphans 2>/dev/null || true
        docker compose up -d
      changed_when: true

    - name: Wait for Prometheus to be ready
      ansible.builtin.wait_for:
        port: 9090
        host: localhost
        delay: 5
        timeout: 60

    - name: Wait for Grafana to be ready
      ansible.builtin.wait_for:
        port: 3000
        host: localhost
        delay: 5
        timeout: 60

    - name: Verify Prometheus targets
      ansible.builtin.uri:
        url: "http://localhost:9090/api/v1/targets"
        return_content: yes
      register: prometheus_targets

    - name: Display Prometheus targets status
      ansible.builtin.debug:
        msg: "Prometheus has {{ prometheus_targets.json.data.activeTargets | length }} active targets"

    - name: Show running containers
      ansible.builtin.command: docker ps
      register: docker_ps
      changed_when: false

    - name: Display running containers
      ansible.builtin.debug:
        var: docker_ps.stdout_lines
