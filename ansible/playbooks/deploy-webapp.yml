---
- name: Deploy WebApp from ECR
  hosts: tag_Role_web
  become: yes
  gather_facts: yes

  vars:
    webapp_dir: /home/ubuntu/webapp
    ecr_region: us-east-1

  tasks:
    - name: Get ECR repository URI from SSM
      ansible.builtin.command:
        cmd: aws ssm get-parameter --name /devops/ecr/webapp-repo-uri --query Parameter.Value --output text --region {{ ecr_region }}
      register: ecr_uri
      changed_when: false

    - name: Create webapp directory
      ansible.builtin.file:
        path: "{{ webapp_dir }}"
        state: directory
        owner: ubuntu
        group: ubuntu
        mode: '0755'

    - name: Copy docker-compose file
      ansible.builtin.copy:
        src: ../files/docker-compose.yml
        dest: "{{ webapp_dir }}/docker-compose.yml"
        owner: ubuntu
        group: ubuntu
        mode: '0644'

    - name: Login to ECR
      ansible.builtin.shell: |
        aws ecr get-login-password --region {{ ecr_region }} | docker login --username AWS --password-stdin {{ ecr_uri.stdout | regex_replace('/.*', '') }}
      become_user: ubuntu
      changed_when: true

    - name: Pull latest image from ECR
      ansible.builtin.command:
        cmd: docker compose pull
        chdir: "{{ webapp_dir }}"
      become_user: ubuntu
      environment:
        IMAGE_URI: "{{ ecr_uri.stdout }}"

    - name: Stop existing containers
      ansible.builtin.command:
        cmd: docker compose down
        chdir: "{{ webapp_dir }}"
      become_user: ubuntu
      ignore_errors: yes

    - name: Start containers
      ansible.builtin.command:
        cmd: docker compose up -d
        chdir: "{{ webapp_dir }}"
      become_user: ubuntu
      environment:
        IMAGE_URI: "{{ ecr_uri.stdout }}"

    - name: Wait for container to be healthy
      ansible.builtin.wait_for:
        port: 80
        delay: 5
        timeout: 30

    - name: Show running containers
      ansible.builtin.command:
        cmd: docker ps
      become_user: ubuntu
      register: docker_ps

    - name: Display running containers
      ansible.builtin.debug:
        var: docker_ps.stdout_lines