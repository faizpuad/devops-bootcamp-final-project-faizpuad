---
- name: Deploy WebApp from ECR
  hosts: tag_Role_web
  become: yes
  gather_facts: yes

  vars:
    webapp_dir: /home/ubuntu/webapp

  tasks:
    - name: Get ECR repository URI from SSM
      ansible.builtin.command:
        cmd: aws ssm get-parameter --name "/devops/ecr/webapp-repo-uri" --query "Parameter.Value" --output text --region us-east-1
      register: ecr_uri
      changed_when: false
      become: no

    - name: Display ECR URI
      ansible.builtin.debug:
        msg: "ECR Repository: {{ ecr_uri.stdout }}"

    - name: Create webapp directory
      ansible.builtin.file:
        path: "{{ webapp_dir }}"
        state: directory
        owner: ubuntu
        group: ubuntu
        mode: '0755'

    - name: Download docker-compose.yml from S3
      ansible.builtin.command:
        cmd: aws s3 cp s3://{{ lookup('env', 'TF_STATE_BUCKET') }}/webapp/docker-compose.yml {{ webapp_dir }}/docker-compose.yml
      become: no

    - name: Set permissions on docker-compose.yml
      ansible.builtin.file:
        path: "{{ webapp_dir }}/docker-compose.yml"
        owner: ubuntu
        group: ubuntu
        mode: '0644'

    - name: Download deployment script from S3
      ansible.builtin.command:
        cmd: aws s3 cp s3://{{ lookup('env', 'TF_STATE_BUCKET') }}/scripts/deploy-webapp.sh /tmp/deploy-webapp.sh
      become: no

    - name: Make deployment script executable
      ansible.builtin.file:
        path: /tmp/deploy-webapp.sh
        mode: '0755'

    - name: Run deployment script
      ansible.builtin.command:
        cmd: /tmp/deploy-webapp.sh
      environment:
        TF_STATE_BUCKET: "{{ lookup('env', 'TF_STATE_BUCKET') }}"
      register: deploy_output

    - name: Display deployment output
      ansible.builtin.debug:
        var: deploy_output.stdout_lines

    - name: Verify containers are running
      ansible.builtin.command:
        cmd: docker compose ps
        chdir: "{{ webapp_dir }}"
      register: container_status
      changed_when: false

    - name: Display container status
      ansible.builtin.debug:
        var: container_status.stdout_lines