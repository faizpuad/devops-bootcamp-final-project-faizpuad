---
- name: Deploy Node Exporter on Web Server
  hosts: tag_Role_web
  become: yes
  gather_facts: no

  vars:
    node_exporter_version: "latest"
    node_exporter_port: 9100

  tasks:
    - name: Create node-exporter directory
      ansible.builtin.file:
        path: /home/ubuntu/node-exporter
        state: directory
        owner: ubuntu
        group: ubuntu
        mode: '0755'

    - name: Create docker-compose for node-exporter
      ansible.builtin.copy:
        content: |
          services:
            node-exporter:
              image: prom/node-exporter:{{ node_exporter_version }}
              container_name: node-exporter
              restart: unless-stopped
              ports:
                - "{{ node_exporter_port }}:9100"
              volumes:
                - /proc:/host/proc:ro
                - /sys:/host/sys:ro
                - /:/rootfs:ro
              command:
                - '--path.procfs=/host/proc'
                - '--path.sysfs=/host/sys'
                - '--path.rootfs=/rootfs'
                - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)'
        dest: /home/ubuntu/node-exporter/docker-compose.yml
        owner: ubuntu
        group: ubuntu
        mode: '0644'

    - name: Deploy Node Exporter
      ansible.builtin.shell: |
        cd /home/ubuntu/node-exporter
        docker compose down --remove-orphans 2>/dev/null || true
        docker compose up -d
      changed_when: true

    - name: Wait for Node Exporter to be ready
      ansible.builtin.wait_for:
        port: "{{ node_exporter_port }}"
        host: localhost
        delay: 3
        timeout: 30

    - name: Verify Node Exporter metrics endpoint
      ansible.builtin.uri:
        url: "http://localhost:{{ node_exporter_port }}/metrics"
        return_content: no
      register: metrics_check

    - name: Display Node Exporter status
      ansible.builtin.debug:
        msg: "Node Exporter is running and accessible on port {{ node_exporter_port }}"
