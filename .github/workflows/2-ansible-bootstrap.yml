name: Bootstrap Ansible Controller (Simplified)

on:
  workflow_run:
    workflows: ["Terraform Apply"]
    types:
      - completed

env:
  AWS_REGION: us-east-1

jobs:
  install-ansible:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get Ansible Controller Instance ID
        run: |
          INSTANCE_ID=$(aws ssm get-parameter \
            --name "/devops/controller/instance-id" \
            --query "Parameter.Value" \
            --output text)
          echo "INSTANCE_ID=$INSTANCE_ID" >> $GITHUB_ENV

      - name: Check if Ansible is installed
        id: check_ansible
        run: |
          CHECK_CMD=$(aws ssm send-command \
            --instance-ids "$INSTANCE_ID" \
            --document-name "AWS-RunShellScript" \
            --parameters 'commands=["which ansible || echo NOT_INSTALLED"]' \
            --query "Command.CommandId" \
            --output text)
          sleep 10
          
          RESULT=$(aws ssm get-command-invocation \
            --command-id "$CHECK_CMD" \
            --instance-id "$INSTANCE_ID" \
            --query 'StandardOutputContent' \
            --output text)
          
          if [[ "$RESULT" == *"NOT_INSTALLED"* ]]; then
            echo "installed=false" >> $GITHUB_OUTPUT
          else
            echo "installed=true" >> $GITHUB_OUTPUT
          fi

      - name: Install Ansible and Requirements
        if: steps.check_ansible.outputs.installed == 'false'
        run: |
          INSTALL_CMD=$(aws ssm send-command \
            --instance-ids "$INSTANCE_ID" \
            --document-name "AWS-RunShellScript" \
            --parameters 'commands=["#!/bin/bash","set -e","sudo apt-get update -qq","sudo apt-get install -y software-properties-common python3-pip","sudo add-apt-repository -y ppa:ansible/ansible","sudo apt-get update -qq","sudo apt-get install -y ansible","pip3 install --break-system-packages boto3 botocore","ansible --version"]' \
            --timeout-seconds 600 \
            --query "Command.CommandId" \
            --output text)
          
          # Wait for completion
          for i in {1..60}; do
            STATUS=$(aws ssm get-command-invocation \
              --command-id "$INSTALL_CMD" \
              --instance-id "$INSTANCE_ID" \
              --query 'Status' \
              --output text)
            
            if [ "$STATUS" = "Success" ]; then
              echo "✓ Ansible installed"
              break
            elif [ "$STATUS" = "Failed" ]; then
              echo "✗ Installation failed"
              exit 1
            fi
            sleep 10
          done

      - name: Install Ansible Collections
        run: |
          COLLECTION_CMD=$(aws ssm send-command \
            --instance-ids "$INSTANCE_ID" \
            --document-name "AWS-RunShellScript" \
            --parameters 'commands=["ansible-galaxy collection install amazon.aws community.general"]' \
            --timeout-seconds 300 \
            --query "Command.CommandId" \
            --output text)
          
          sleep 15
          aws ssm get-command-invocation \
            --command-id "$COLLECTION_CMD" \
            --instance-id "$INSTANCE_ID"

      - name: Clone/Update Git Repo on Controller
        run: |
          CLONE_CMD=$(aws ssm send-command \
            --instance-ids "$INSTANCE_ID" \
            --document-name "AWS-RunShellScript" \
            --parameters 'commands=["#!/bin/bash","set -e","cd /home/ssm-user","if [ -d devops-bootcamp ]; then","  cd devops-bootcamp && git pull","else","  git clone https://github.com/${{ github.repository }}.git devops-bootcamp","fi","chown -R ssm-user: /home/ssm-user/devops-bootcamp","echo ✓ Repository ready"]' \
            --timeout-seconds 300 \
            --query "Command.CommandId" \
            --output text)
          
          # Wait for completion
          for i in {1..30}; do
            STATUS=$(aws ssm get-command-invocation \
              --command-id "$CLONE_CMD" \
              --instance-id "$INSTANCE_ID" \
              --query 'Status' \
              --output text)
            
            if [ "$STATUS" = "Success" ]; then
              echo "✓ Repository cloned/updated"
              break
            elif [ "$STATUS" = "Failed" ]; then
              echo "✗ Git clone failed"
              exit 1
            fi
            sleep 10
          done

      - name: Test Ansible Inventory
        run: |
          TEST_CMD=$(aws ssm send-command \
            --instance-ids "$INSTANCE_ID" \
            --document-name "AWS-RunShellScript" \
            --parameters 'commands=["#!/bin/bash","cd /home/ssm-user/devops-bootcamp/ansible","ansible-inventory -i inventory/ssm_inventory.aws_ec2.yml --graph","ansible tag_Role_web -i inventory/ssm_inventory.aws_ec2.yml -m ping"]' \
            --timeout-seconds 300 \
            --query "Command.CommandId" \
            --output text)
          
          sleep 20
          OUTPUT=$(aws ssm get-command-invocation \
            --command-id "$TEST_CMD" \
            --instance-id "$INSTANCE_ID" \
            --query 'StandardOutputContent' \
            --output text)
          echo "$OUTPUT"