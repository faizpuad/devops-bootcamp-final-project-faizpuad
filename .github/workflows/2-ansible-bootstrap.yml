name: Bootstrap Ansible Controller

on:
  workflow_run:
    workflows: ["Terraform Apply"]
    types:
      - completed

env:
  AWS_REGION: us-east-1

jobs:
  install-ansible:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get Ansible Controller Instance ID
        run: |
          INSTANCE_ID=$(aws ssm get-parameter \
            --name "/devops/controller/instance-id" \
            --query "Parameter.Value" \
            --output text)
          echo "INSTANCE_ID=$INSTANCE_ID" >> $GITHUB_ENV
          echo "Ansible Controller Instance ID: $INSTANCE_ID"

      - name: Check if Ansible is installed
        id: check_ansible
        run: |
          CHECK_CMD=$(aws ssm send-command \
            --instance-ids "$INSTANCE_ID" \
            --document-name "AWS-RunShellScript" \
            --parameters 'commands=["which ansible || echo NOT_INSTALLED"]' \
            --query "Command.CommandId" \
            --output text)
          sleep 10
          
          RESULT=$(aws ssm get-command-invocation \
            --command-id "$CHECK_CMD" \
            --instance-id "$INSTANCE_ID" \
            --query 'StandardOutputContent' \
            --output text)
          
          if [[ "$RESULT" == *"NOT_INSTALLED"* ]]; then
            echo "installed=false" >> $GITHUB_OUTPUT
          else
            echo "installed=true" >> $GITHUB_OUTPUT
          fi

      - name: Install Ansible, SSM Plugin, and Requirements
        if: steps.check_ansible.outputs.installed == 'false'
        run: |
          INSTALL_CMD=$(aws ssm send-command \
            --instance-ids "$INSTANCE_ID" \
            --document-name "AWS-RunShellScript" \
            --parameters 'commands=[
              "#!/bin/bash",
              "set -e",
              "sudo chown ssm-user:ssm-user /home/ssm-user",
              "sudo apt-get update -qq",
              "sudo apt-get install -y software-properties-common python3-pip curl",
              "sudo add-apt-repository -y ppa:ansible/ansible",
              "sudo apt-get update -qq",
              "sudo apt-get install -y ansible",
              "echo Installing Session Manager Plugin...",
              "curl \"https://s3.amazonaws.com/session-manager-downloads/plugin/latest/ubuntu_64bit/session-manager-plugin.deb\" -o \"session-manager-plugin.deb\"",
              "sudo dpkg -i session-manager-plugin.deb",
              "rm session-manager-plugin.deb",
              "pip3 install --break-system-packages boto3 botocore",
              "ansible --version",
              "session-manager-plugin --version"
            ]' \
            --timeout-seconds 600 \
            --query "Command.CommandId" \
            --output text)
          
          for i in {1..60}; do
            STATUS=$(aws ssm get-command-invocation --command-id "$INSTALL_CMD" --instance-id "$INSTANCE_ID" --query 'Status' --output text)
            if [ "$STATUS" = "Success" ]; then
              echo "✓ Dependencies installed"
              break
            elif [ "$STATUS" = "Failed" ]; then
              aws ssm get-command-invocation --command-id "$INSTALL_CMD" --instance-id "$INSTANCE_ID" --query '[StandardOutputContent,StandardErrorContent]' --output text
              exit 1
            fi
            sleep 10
          done

      - name: Install Ansible Collections
        run: |
          COLLECTION_CMD=$(aws ssm send-command \
            --instance-ids "$INSTANCE_ID" \
            --document-name "AWS-RunShellScript" \
            --parameters 'commands=["ansible-galaxy collection install amazon.aws community.general"]' \
            --query "Command.CommandId" \
            --output text)
          
          sleep 15
          echo "✓ Collections installed"

      - name: Clone/Update Git Repo on Controller
        run: |
          COMMANDS_JSON=$(cat <<EOF
          [
            "#!/bin/bash",
            "set -e",
            "sudo chown ssm-user:ssm-user /home/ssm-user",
            "cd /home/ssm-user",
            "if [ -d devops-bootcamp/.git ]; then",
            "  echo 'Repository exists, updating...'",
            "  cd devops-bootcamp",
            "  git config --global --add safe.directory /home/ssm-user/devops-bootcamp",
            "  git fetch --all",
            "  git reset --hard origin/main",
            "else",
            "  echo 'Repository missing, re-cloning...'",
            "  sudo rm -rf devops-bootcamp",
            "  git clone https://github.com/${{ github.repository }}.git devops-bootcamp",
            "  cd devops-bootcamp",
            "  git config --global --add safe.directory /home/ssm-user/devops-bootcamp",
            "fi",
            "ls -la ansible/"
          ]
          EOF
          )

          CLONE_CMD=$(aws ssm send-command \
            --instance-ids "$INSTANCE_ID" \
            --document-name "AWS-RunShellScript" \
            --parameters "{\"commands\": $COMMANDS_JSON}" \
            --query "Command.CommandId" \
            --output text)
          
          sleep 15
          echo "✓ Repository ready"

      - name: Test Ansible Inventory (Ping)
        run: |
          TEST_CMD=$(aws ssm send-command \
            --instance-ids "$INSTANCE_ID" \
            --document-name "AWS-RunShellScript" \
            --parameters 'commands=["#!/bin/bash","cd /home/ssm-user/devops-bootcamp/ansible","ansible tag_Role_web -i inventory/ssm_inventory.aws_ec2.yml -m ping"]' \
            --query "Command.CommandId" \
            --output text)
          
          echo "Waiting for Ping test..."
          for i in {1..20}; do
            STATUS=$(aws ssm get-command-invocation --command-id "$TEST_CMD" --instance-id "$INSTANCE_ID" --query 'Status' --output text)
            if [ "$STATUS" = "Success" ]; then
              aws ssm get-command-invocation --command-id "$TEST_CMD" --instance-id "$INSTANCE_ID" --query 'StandardOutputContent' --output text
              break
            elif [ "$STATUS" = "Failed" ]; then
              echo "✗ Ping test failed"
              aws ssm get-command-invocation --command-id "$TEST_CMD" --instance-id "$INSTANCE_ID" --query 'StandardErrorContent' --output text
              exit 1
            fi
            sleep 5
          done

      - name: Bootstrap Summary
        run: |
          echo "### Ansible Controller Bootstrap Summary" >> $GITHUB_STEP_SUMMARY
          echo "✅ **Status:** Bootstrap Successful" >> $GITHUB_STEP_SUMMARY
          echo "**Instance ID:** \`${{ env.INSTANCE_ID }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Ansible & SSM Plugin:** Installed" >> $GITHUB_STEP_SUMMARY