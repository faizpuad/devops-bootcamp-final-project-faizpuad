name: Bootstrap Ansible Controller

on:
  workflow_run:
    workflows: ["Terraform Apply"]
    types:
      - completed

env:
  AWS_REGION: us-east-1

jobs:
  install-ansible:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get Ansible Controller Instance ID
        run: |
          INSTANCE_ID=$(aws ssm get-parameter \
            --name "/devops/controller/instance-id" \
            --query "Parameter.Value" \
            --output text)
          echo "INSTANCE_ID=$INSTANCE_ID" >> $GITHUB_ENV
          echo "Ansible Controller Instance ID: $INSTANCE_ID"

      - name: Ensure ssm-user and Permissions (Always Runs)
        run: |
          aws ssm send-command \
            --instance-ids "$INSTANCE_ID" \
            --document-name "AWS-RunShellScript" \
            --parameters 'commands=[
              "#!/bin/bash",
              "if ! id -u ssm-user > /dev/null 2>&1; then",
              "  sudo useradd -m -s /bin/bash ssm-user",
              "  echo \"ssm-user:ssm-user\" | sudo chpasswd",
              "  echo \"ssm-user ALL=(ALL) NOPASSWD:ALL\" | sudo tee /etc/sudoers.d/ssm-agent-users",
              "fi",
              "sudo mkdir -p /tmp/.ansible/tmp",
              "sudo chown -R ssm-user:ssm-user /tmp/.ansible",
              "sudo chown ssm-user:ssm-user /home/ssm-user"
            ]'

      - name: Check if Ansible is installed
        id: check_ansible
        run: |
          CHECK_CMD=$(aws ssm send-command \
            --instance-ids "$INSTANCE_ID" \
            --document-name "AWS-RunShellScript" \
            --parameters 'commands=["command -v ansible || echo NOT_INSTALLED"]' \
            --query "Command.CommandId" \
            --output text)
          sleep 10
          RESULT=$(aws ssm get-command-invocation --command-id "$CHECK_CMD" --instance-id "$INSTANCE_ID" --query 'StandardOutputContent' --output text)
          if [[ "$RESULT" == *"NOT_INSTALLED"* ]]; then
            echo "installed=false" >> $GITHUB_OUTPUT
          else
            echo "installed=true" >> $GITHUB_OUTPUT
          fi

      - name: Install Ansible, AWS CLI v2, SSM Plugin, and Requirements
        if: steps.check_ansible.outputs.installed == 'false'
        run: |
          INSTALL_CMD=$(aws ssm send-command \
            --instance-ids "$INSTANCE_ID" \
            --document-name "AWS-RunShellScript" \
            --parameters 'commands=[
              "#!/bin/bash",
              "set -e",
              "cd /tmp",
              "sudo apt-get update -qq",
              "sudo apt-get install -y software-properties-common python3-pip curl unzip",
              "sudo add-apt-repository -y ppa:ansible/ansible",
              "sudo apt-get update -qq",
              "sudo apt-get install -y ansible",
              
              "echo Installing AWS CLI v2...",
              "curl -s \"https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip\" -o \"awscliv2.zip\"",
              "unzip -q awscliv2.zip && sudo ./aws/install --update && rm -rf awscliv2.zip aws",
              
              "echo Installing Session Manager Plugin...",
              "curl -s \"https://s3.amazonaws.com/session-manager-downloads/plugin/latest/ubuntu_64bit/session-manager-plugin.deb\" -o \"ssm-plugin.deb\"",
              "sudo dpkg -i ssm-plugin.deb && rm ssm-plugin.deb",
              
              "pip3 install --break-system-packages boto3 botocore",
              
              "sudo mkdir -p /tmp/.ansible/tmp",
              "sudo chown -R ssm-user:ssm-user /tmp/.ansible",
              
              "ansible --version",
              "aws --version",
              "session-manager-plugin --version"
            ]' \
            --timeout-seconds 600 \
            --query "Command.CommandId" \
            --output text)
          
          for i in {1..60}; do
            STATUS=$(aws ssm get-command-invocation --command-id "$INSTALL_CMD" --instance-id "$INSTANCE_ID" --query 'Status' --output text)
            if [ "$STATUS" = "Success" ]; then
              echo "✓ All core dependencies installed"
              break
            elif [ "$STATUS" = "Failed" ]; then
              aws ssm get-command-invocation --command-id "$INSTALL_CMD" --instance-id "$INSTANCE_ID" --query '[StandardOutputContent,StandardErrorContent]' --output text
              exit 1
            fi
            sleep 10
          done

      - name: Install Ansible Collections
        run: |
          COLLECTION_CMD=$(aws ssm send-command \
            --instance-ids "$INSTANCE_ID" \
            --document-name "AWS-RunShellScript" \
            --parameters 'commands=["sudo -u ssm-user ansible-galaxy collection install amazon.aws community.general"]' \
            --query "Command.CommandId" \
            --output text)
          sleep 15
          echo "✓ Collections installed"

      - name: Clone/Update Git Repo on Controller
        run: |
          COMMANDS_JSON=$(cat <<EOF
          [
            "#!/bin/bash",
            "set -e",
            "sudo chown ssm-user:ssm-user /home/ssm-user",
            "cd /home/ssm-user",
            "if [ -d devops-bootcamp/.git ]; then",
            "  cd devops-bootcamp",
            "  git config --global --add safe.directory /home/ssm-user/devops-bootcamp",
            "  git fetch --all && git reset --hard origin/main",
            "else",
            "  git clone https://github.com/${{ github.repository }}.git devops-bootcamp",
            "  cd devops-bootcamp",
            "  git config --global --add safe.directory /home/ssm-user/devops-bootcamp",
            "fi",
            "sudo chown -R ssm-user:ssm-user /home/ssm-user/devops-bootcamp",
            "echo '✓ Repository permissions fixed'"
          ]
          EOF
          )
          CLONE_CMD=$(aws ssm send-command --instance-ids "$INSTANCE_ID" --document-name "AWS-RunShellScript" --parameters "{\"commands\": $COMMANDS_JSON}" --query "Command.CommandId" --output text)
          sleep 15

      - name: Test Ansible Inventory (Ping)
        run: |
          TEST_CMD=$(aws ssm send-command \
            --instance-ids "$INSTANCE_ID" \
            --document-name "AWS-RunShellScript" \
            --parameters 'commands=["#!/bin/bash","sudo -u ssm-user bash -c \"cd /home/ssm-user/devops-bootcamp/ansible && export AWS_REGION=us-east-1 && ansible tag_Role_web -m ping\""]' \
            --query "Command.CommandId" \
            --output text)
          
          echo "Waiting for Ping test..."
          for i in {1..20}; do
            STATUS=$(aws ssm get-command-invocation --command-id "$TEST_CMD" --instance-id "$INSTANCE_ID" --query 'Status' --output text)
            if [ "$STATUS" = "Success" ]; then
              aws ssm get-command-invocation --command-id "$TEST_CMD" --instance-id "$INSTANCE_ID" --query 'StandardOutputContent' --output text
              break
            elif [ "$STATUS" = "Failed" ]; then
              echo "✗ Ping test failed"
              aws ssm get-command-invocation --command-id "$TEST_CMD" --instance-id "$INSTANCE_ID" --query '[StandardOutputContent,StandardErrorContent]' --output text
              exit 1
            fi
            sleep 5
          done

      - name: Bootstrap Summary
        run: |
          echo "### Ansible Controller Bootstrap Summary" >> $GITHUB_STEP_SUMMARY
          echo "✅ **Status:** Bootstrap Successful" >> $GITHUB_STEP_SUMMARY
          echo "**Instance ID:** \`${{ env.INSTANCE_ID }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Ansible, AWS CLI, & SSM Plugin:** Installed" >> $GITHUB_STEP_SUMMARY