name: Bootstrap Ansible Controller

on:
  workflow_run:
    workflows: ["Terraform Apply"]
    types:
      - completed

env:
  AWS_REGION: us-east-1

jobs:
  install-ansible:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get Ansible Controller Instance ID
        run: |
          INSTANCE_ID=$(aws ssm get-parameter \
            --name "/devops/controller/instance-id" \
            --query "Parameter.Value" \
            --output text)
          echo "INSTANCE_ID=$INSTANCE_ID" >> $GITHUB_ENV
          echo "Ansible Controller Instance ID: $INSTANCE_ID"

      - name: Check if Ansible is installed
        id: check_ansible
        run: |
          CHECK_CMD=$(aws ssm send-command \
            --instance-ids "$INSTANCE_ID" \
            --document-name "AWS-RunShellScript" \
            --parameters 'commands=["which ansible || echo NOT_INSTALLED"]' \
            --query "Command.CommandId" \
            --output text)
          sleep 10
          
          RESULT=$(aws ssm get-command-invocation \
            --command-id "$CHECK_CMD" \
            --instance-id "$INSTANCE_ID" \
            --query 'StandardOutputContent' \
            --output text)
          
          if [[ "$RESULT" == *"NOT_INSTALLED"* ]]; then
            echo "installed=false" >> $GITHUB_OUTPUT
          else
            echo "installed=true" >> $GITHUB_OUTPUT
          fi

      - name: Install Ansible and Requirements
        if: steps.check_ansible.outputs.installed == 'false'
        run: |
          INSTALL_CMD=$(aws ssm send-command \
            --instance-ids "$INSTANCE_ID" \
            --document-name "AWS-RunShellScript" \
            --parameters 'commands=["#!/bin/bash","set -e","sudo chown ssm-user: /home/ssm-user","sudo chown -R ssm-user: /tmp/.ansible 2>/dev/null || true","sudo apt-get update -qq","sudo apt-get install -y software-properties-common python3-pip","sudo add-apt-repository -y ppa:ansible/ansible","sudo apt-get update -qq","sudo apt-get install -y ansible","pip3 install --break-system-packages boto3 botocore","ansible --version"]' \
            --timeout-seconds 600 \
            --query "Command.CommandId" \
            --output text)
          
          for i in {1..60}; do
            STATUS=$(aws ssm get-command-invocation \
              --command-id "$INSTALL_CMD" \
              --instance-id "$INSTANCE_ID" \
              --query 'Status' \
              --output text)
            
            if [ "$STATUS" = "Success" ]; then
              echo "✓ Ansible installed"
              break
            elif [ "$STATUS" = "Failed" ]; then
              echo "✗ Installation failed"
              exit 1
            fi
            sleep 10
          done

      - name: Install Ansible Collections
        run: |
          COLLECTION_CMD=$(aws ssm send-command \
            --instance-ids "$INSTANCE_ID" \
            --document-name "AWS-RunShellScript" \
            --parameters 'commands=["ansible-galaxy collection install amazon.aws community.general"]' \
            --timeout-seconds 300 \
            --query "Command.CommandId" \
            --output text)
          
          sleep 20
          echo "✓ Collections installed"

      - name: Clone/Update Git Repo on Controller
        run: |
          CLONE_CMD=$(aws ssm send-command \
            --instance-ids "$INSTANCE_ID" \
            --document-name "AWS-RunShellScript" \
            --parameters 'commands=["#!/bin/bash","set -e","echo Preparing repository...","sudo chown ssm-user: /home/ssm-user 2>/dev/null || true","cd /home/ssm-user","if [ -d devops-bootcamp/.git ]; then","  echo Repository exists, updating...","  cd devops-bootcamp","  git fetch --all","  git reset --hard origin/main","  git pull origin main","  echo ✓ Repository updated","else","  echo Repository does not exist, cloning...","  git clone https://github.com/${{ github.repository }}.git devops-bootcamp","  echo ✓ Repository cloned","fi","sudo chown -R ssm-user: /home/ssm-user/devops-bootcamp 2>/dev/null || true","echo","echo === Repository Status ===","cd /home/ssm-user/devops-bootcamp","git log -1 --oneline","git status","echo ✓ Repository ready"]' \
            --timeout-seconds 300 \
            --query "Command.CommandId" \
            --output text)
          
          echo "Clone/Update Command ID: $CLONE_CMD"
          
          for i in {1..30}; do
            STATUS=$(aws ssm get-command-invocation \
              --command-id "$CLONE_CMD" \
              --instance-id "$INSTANCE_ID" \
              --query 'Status' \
              --output text 2>/dev/null || echo "Pending")
            
            echo "Repository check $i/30 - Status: $STATUS"
            
            if [ "$STATUS" = "Success" ]; then
              echo "✓ Repository ready"
              OUTPUT=$(aws ssm get-command-invocation \
                --command-id "$CLONE_CMD" \
                --instance-id "$INSTANCE_ID" \
                --query 'StandardOutputContent' \
                --output text)
              echo "$OUTPUT"
              break
            elif [ "$STATUS" = "Failed" ]; then
              echo "✗ Repository setup failed"
              ERROR=$(aws ssm get-command-invocation \
                --command-id "$CLONE_CMD" \
                --instance-id "$INSTANCE_ID" \
                --query '[StandardOutputContent,StandardErrorContent]' \
                --output text)
              echo "Error output:"
              echo "$ERROR"
              exit 1
            fi
            sleep 10
          done

      - name: Test Ansible Inventory
        run: |
          TEST_CMD=$(aws ssm send-command \
            --instance-ids "$INSTANCE_ID" \
            --document-name "AWS-RunShellScript" \
            --parameters 'commands=["#!/bin/bash","cd /home/ssm-user/devops-bootcamp/ansible","ansible-inventory -i inventory/ssm_inventory.aws_ec2.yml --graph","ansible tag_Role_web -i inventory/ssm_inventory.aws_ec2.yml -m ping"]' \
            --timeout-seconds 300 \
            --query "Command.CommandId" \
            --output text)
          
          sleep 20
          OUTPUT=$(aws ssm get-command-invocation \
            --command-id "$TEST_CMD" \
            --instance-id "$INSTANCE_ID" \
            --query 'StandardOutputContent' \
            --output text)
          echo "$OUTPUT"

      - name: Bootstrap Summary
        run: |
          echo "### Ansible Controller Bootstrap Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ **Status:** Bootstrap Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Instance ID:** \`${{ env.INSTANCE_ID }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Repository:** Cloned to \`/home/ssm-user/devops-bootcamp\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next Steps:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Manually trigger 'ECR Build and Push' workflow" >> $GITHUB_STEP_SUMMARY
          echo "2. 'Deploy WebApp' will auto-trigger on successful build" >> $GITHUB_STEP_SUMMARY