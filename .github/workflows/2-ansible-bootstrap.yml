name: Bootstrap Ansible Controller

on:
  workflow_run:
    workflows: ["Terraform Apply"]
    types:
      - completed

env:
  AWS_REGION: us-east-1

jobs:
  install-ansible:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get Ansible Controller Instance ID
        run: |
          INSTANCE_ID=$(aws ssm get-parameter \
            --name "/devops/controller/instance-id" \
            --query "Parameter.Value" \
            --output text)
          echo "INSTANCE_ID=$INSTANCE_ID" >> $GITHUB_ENV
          echo "Ansible Controller Instance ID: $INSTANCE_ID"

      - name: Upload scripts and configs to S3
        run: |
          BUCKET="${{ vars.TF_STATE_BUCKET }}"
          
          # Upload all bash scripts
          aws s3 sync bash/ s3://${BUCKET}/scripts/
          
          # Upload Ansible inventory and config (note the new filename)
          aws s3 cp ansible/inventory/ssm_inventory.aws_ec2.yml s3://${BUCKET}/ansible/inventory/ssm_inventory.aws_ec2.yml
          aws s3 cp ansible/ansible.cfg s3://${BUCKET}/ansible/ansible.cfg
          aws s3 cp ansible/group_vars/all.yml s3://${BUCKET}/ansible/group_vars/all.yml
          
          echo "✅ Scripts and configs uploaded to S3"

      - name: Check if Ansible is already installed
        id: check_ansible
        run: |
          CHECK_CMD=$(aws ssm send-command \
            --instance-ids "$INSTANCE_ID" \
            --document-name "AWS-RunShellScript" \
            --parameters 'commands=["which ansible && ansible --version || echo ANSIBLE_NOT_INSTALLED"]' \
            --query "Command.CommandId" \
            --output text)
          
          echo "Check Command ID: $CHECK_CMD"
          sleep 10
          
          ANSIBLE_STATUS=$(aws ssm get-command-invocation \
            --command-id "$CHECK_CMD" \
            --instance-id "$INSTANCE_ID" \
            --query 'StandardOutputContent' \
            --output text)
          
          if [[ "$ANSIBLE_STATUS" == *"ANSIBLE_NOT_INSTALLED"* ]]; then
            echo "ansible_installed=false" >> $GITHUB_OUTPUT
            echo "Ansible is not installed"
          else
            echo "ansible_installed=true" >> $GITHUB_OUTPUT
            echo "Ansible is already installed:"
            echo "$ANSIBLE_STATUS"
          fi

      - name: Install Ansible on Controller via SSM
        if: steps.check_ansible.outputs.ansible_installed == 'false'
        run: |
          echo "Installing Ansible..."
          INSTALL_CMD=$(aws ssm send-command \
            --instance-ids "$INSTANCE_ID" \
            --document-name "AWS-RunShellScript" \
            --parameters 'commands=["#!/bin/bash","set -e","echo Starting Ansible installation...","sudo apt-get update -qq","sudo apt-get install -y software-properties-common python3-pip","sudo add-apt-repository -y ppa:ansible/ansible","sudo apt-get update -qq","sudo apt-get install -y ansible","echo Ansible installation completed","ansible --version"]' \
            --timeout-seconds 600 \
            --comment "Install Ansible" \
            --query "Command.CommandId" \
            --output text)
          
          echo "Install Command ID: $INSTALL_CMD"
          
          # Poll for completion (up to 10 minutes)
          MAX_ATTEMPTS=60
          ATTEMPT=0
          
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            STATUS=$(aws ssm get-command-invocation \
              --command-id "$INSTALL_CMD" \
              --instance-id "$INSTANCE_ID" \
              --query 'Status' \
              --output text 2>/dev/null || echo "Pending")
            
            echo "Installation check $((ATTEMPT+1))/$MAX_ATTEMPTS - Status: $STATUS"
            
            if [ "$STATUS" = "Success" ]; then
              echo "✓ Ansible installation completed successfully!"
              OUTPUT=$(aws ssm get-command-invocation \
                --command-id "$INSTALL_CMD" \
                --instance-id "$INSTANCE_ID" \
                --query 'StandardOutputContent' \
                --output text)
              echo "Installation output:"
              echo "$OUTPUT"
              exit 0
            elif [ "$STATUS" = "Failed" ] || [ "$STATUS" = "Cancelled" ] || [ "$STATUS" = "TimedOut" ]; then
              echo "✗ Installation failed with status: $STATUS"
              ERROR=$(aws ssm get-command-invocation \
                --command-id "$INSTALL_CMD" \
                --instance-id "$INSTANCE_ID" \
                --query '[StandardOutputContent,StandardErrorContent]' \
                --output text)
              echo "Error output:"
              echo "$ERROR"
              exit 1
            fi
            
            sleep 10
            ATTEMPT=$((ATTEMPT+1))
          done
          
          echo "✗ Timeout waiting for Ansible installation to complete"
          exit 1

      - name: Install Ansible Requirements (boto3, botocore, AWS CLI)
        run: |
          echo "Installing Ansible requirements (AWS CLI, boto3, botocore)..."
          REQUIREMENTS_CMD=$(aws ssm send-command \
            --instance-ids "$INSTANCE_ID" \
            --document-name "AWS-RunShellScript" \
            --parameters 'commands=["#!/bin/bash","set -e","echo === Checking AWS CLI ===","if command -v aws &> /dev/null; then","  echo AWS CLI already installed: $(aws --version)","else","  echo Installing AWS CLI...","  cd /tmp","  curl -s https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip -o awscliv2.zip","  sudo apt-get update -qq && sudo apt-get install -y unzip","  unzip -q awscliv2.zip","  sudo ./aws/install","  rm -rf awscliv2.zip aws/","  aws --version","fi","echo","echo === Installing pip3 if needed ===","if ! command -v pip3 &> /dev/null; then","  sudo apt-get install -y python3-pip","fi","pip3 --version","echo","echo === Installing boto3 and botocore ===","pip3 install --break-system-packages boto3 botocore","echo","echo === Verification ===","aws --version","python3 -c \"import boto3; print(f'"'"'boto3: {boto3.__version__}'"'"')\"","python3 -c \"import botocore; print(f'"'"'botocore: {botocore.__version__}'"'"')\"","echo === Installation complete ==="]' \
            --timeout-seconds 600 \
            --comment "Install AWS CLI, boto3, botocore" \
            --query "Command.CommandId" \
            --output text)
          
          echo "Requirements Command ID: $REQUIREMENTS_CMD"
          
          MAX_ATTEMPTS=60
          ATTEMPT=0
          
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            STATUS=$(aws ssm get-command-invocation \
              --command-id "$REQUIREMENTS_CMD" \
              --instance-id "$INSTANCE_ID" \
              --query 'Status' \
              --output text 2>/dev/null || echo "Pending")
            
            echo "Requirements check $((ATTEMPT+1))/$MAX_ATTEMPTS - Status: $STATUS"
            
            if [ "$STATUS" = "Success" ]; then
              echo "✓ Ansible requirements installed successfully!"
              OUTPUT=$(aws ssm get-command-invocation \
                --command-id "$REQUIREMENTS_CMD" \
                --instance-id "$INSTANCE_ID" \
                --query 'StandardOutputContent' \
                --output text)
              echo "Requirements output:"
              echo "$OUTPUT"
              break
            elif [ "$STATUS" = "Failed" ] || [ "$STATUS" = "Cancelled" ] || [ "$STATUS" = "TimedOut" ]; then
              echo "✗ Requirements installation failed with status: $STATUS"
              ERROR=$(aws ssm get-command-invocation \
                --command-id "$REQUIREMENTS_CMD" \
                --instance-id "$INSTANCE_ID" \
                --query '[StandardOutputContent,StandardErrorContent]' \
                --output text)
              echo "Error output:"
              echo "$ERROR"
              exit 1
            fi
            
            sleep 10
            ATTEMPT=$((ATTEMPT+1))
          done

      - name: Install SSM Session Manager Plugin
        run: |
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "$INSTANCE_ID" \
            --document-name "AWS-RunShellScript" \
            --parameters 'commands=["#!/bin/bash","set -e","cd /tmp","curl -s https://s3.amazonaws.com/session-manager-downloads/plugin/latest/ubuntu_64bit/session-manager-plugin.deb -o session-manager-plugin.deb","sudo dpkg -i session-manager-plugin.deb","rm session-manager-plugin.deb","session-manager-plugin --version"]' \
            --timeout-seconds 300 \
            --comment "Install SSM plugin" \
            --query "Command.CommandId" \
            --output text)
          
          echo "SSM Plugin Command ID: $COMMAND_ID"
          
          for i in {1..30}; do
            STATUS=$(aws ssm get-command-invocation \
              --command-id "$COMMAND_ID" \
              --instance-id "$INSTANCE_ID" \
              --query 'Status' \
              --output text 2>/dev/null || echo "Pending")
            
            if [ "$STATUS" = "Success" ]; then
              echo "✓ SSM Plugin installed"
              break
            elif [ "$STATUS" = "Failed" ]; then
              exit 1
            fi
            sleep 10
          done
  
      - name: Create S3 Bucket for Ansible-SSM
        run: |
          AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          BUCKET_NAME="devops-ansible-transfer-${AWS_ACCOUNT_ID}"
          
          if aws s3api head-bucket --bucket "${BUCKET_NAME}" 2>/dev/null; then
            echo "✓ Bucket already exists: ${BUCKET_NAME}"
          else
            echo "Creating bucket: ${BUCKET_NAME}"
            aws s3 mb "s3://${BUCKET_NAME}" --region us-east-1
          fi
          
          echo "ANSIBLE_SSM_BUCKET=${BUCKET_NAME}" >> $GITHUB_ENV
  
      - name: Upload Ansible configs to S3
        run: |
          BUCKET="${{ vars.TF_STATE_BUCKET }}"
          
          # Upload updated files
          aws s3 cp ansible/ansible.cfg s3://${BUCKET}/ansible/ansible.cfg
          aws s3 cp ansible/inventory/ssm_inventory.aws_ec2.yml s3://${BUCKET}/ansible/inventory/ssm_inventory.aws_ec2.yml
          aws s3 cp ansible/group_vars/all.yml s3://${BUCKET}/ansible/group_vars/all.yml
      
      - name: Setup Ansible directory structure
        run: |
          AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          BUCKET_NAME="devops-ansible-transfer-${AWS_ACCOUNT_ID}"
          
          SETUP_CMD=$(aws ssm send-command \
            --instance-ids "$INSTANCE_ID" \
            --document-name "AWS-RunShellScript" \
            --parameters commands=["#!/bin/bash","set -e","mkdir -p /home/ssm-user/ansible/inventory","mkdir -p /home/ssm-user/ansible/playbooks","mkdir -p /home/ssm-user/ansible/group_vars","cd /home/ssm-user","aws s3 cp s3://${{ vars.TF_STATE_BUCKET }}/ansible/inventory/ssm_inventory.aws_ec2.yml ansible/inventory/ssm_inventory.aws_ec2.yml","aws s3 cp s3://${{ vars.TF_STATE_BUCKET }}/ansible/ansible.cfg ansible/ansible.cfg","aws s3 cp s3://${{ vars.TF_STATE_BUCKET }}/ansible/group_vars/all.yml ansible/group_vars/all.yml","export AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)","sed -i \"s/devops-ansible-transfer-.*/devops-ansible-transfer-\${AWS_ACCOUNT_ID}/\" ansible/group_vars/all.yml","chown -R ssm-user:ssm-user /home/ssm-user/ansible","echo Ansible directory structure created"] \
            --timeout-seconds 300 \
            --comment "Setup Ansible directory" \
            --query "Command.CommandId" \
            --output text)
          
          echo "Setup Command ID: $SETUP_CMD"
          
          MAX_ATTEMPTS=30
          ATTEMPT=0
          
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            STATUS=$(aws ssm get-command-invocation \
              --command-id "$SETUP_CMD" \
              --instance-id "$INSTANCE_ID" \
              --query 'Status' \
              --output text 2>/dev/null || echo "Pending")
            
            echo "Setup check $((ATTEMPT+1))/$MAX_ATTEMPTS - Status: $STATUS"
            
            if [ "$STATUS" = "Success" ]; then
              echo "✓ Ansible directory setup completed!"
              break
            elif [ "$STATUS" = "Failed" ] || [ "$STATUS" = "Cancelled" ] || [ "$STATUS" = "TimedOut" ]; then
              echo "✗ Directory setup failed with status: $STATUS"
              ERROR=$(aws ssm get-command-invocation \
                --command-id "$SETUP_CMD" \
                --instance-id "$INSTANCE_ID" \
                --query '[StandardOutputContent,StandardErrorContent]' \
                --output text)
              echo "Error output:"
              echo "$ERROR"
              exit 1
            fi
            
            sleep 10
            ATTEMPT=$((ATTEMPT+1))
          done

      - name: Test Ansible Inventory
        run: |
          echo "Testing Ansible inventory..."
          TEST_CMD=$(aws ssm send-command \
            --instance-ids "$INSTANCE_ID" \
            --document-name "AWS-RunShellScript" \
            --parameters 'commands=["#!/bin/bash","set -e","cd /home/ssm-user/ansible","echo === Testing Ansible inventory ===","ansible-inventory -i inventory/ssm_inventory.aws_ec2.yml --list","echo","echo === Testing connectivity to web server ===","ansible tag_Role_web -i inventory/ssm_inventory.aws_ec2.yml -m ping || echo Warning: Connectivity test failed but continuing..."]' \
            --timeout-seconds 300 \
            --comment "Test Ansible inventory" \
            --query "Command.CommandId" \
            --output text)
          
          echo "Test Command ID: $TEST_CMD"
          
          MAX_ATTEMPTS=30
          ATTEMPT=0
          
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            STATUS=$(aws ssm get-command-invocation \
              --command-id "$TEST_CMD" \
              --instance-id "$INSTANCE_ID" \
              --query 'Status' \
              --output text 2>/dev/null || echo "Pending")
            
            echo "Test check $((ATTEMPT+1))/$MAX_ATTEMPTS - Status: $STATUS"
            
            if [ "$STATUS" = "Success" ]; then
              echo "✓ Inventory test completed!"
              echo ""
              echo "=== Inventory Output ==="
              OUTPUT=$(aws ssm get-command-invocation \
                --command-id "$TEST_CMD" \
                --instance-id "$INSTANCE_ID" \
                --query 'StandardOutputContent' \
                --output text)
              echo "$OUTPUT"
              break
            elif [ "$STATUS" = "Failed" ] || [ "$STATUS" = "Cancelled" ] || [ "$STATUS" = "TimedOut" ]; then
              echo "✗ Inventory test failed with status: $STATUS"
              ERROR=$(aws ssm get-command-invocation \
                --command-id "$TEST_CMD" \
                --instance-id "$INSTANCE_ID" \
                --query '[StandardOutputContent,StandardErrorContent]' \
                --output text)
              echo "Error output:"
              echo "$ERROR"
              exit 1
            fi
            
            sleep 10
            ATTEMPT=$((ATTEMPT+1))
          done

      - name: Verify Ansible installation
        run: |
          echo "Verifying Ansible installation..."
          VERIFY_CMD=$(aws ssm send-command \
            --instance-ids "$INSTANCE_ID" \
            --document-name "AWS-RunShellScript" \
            --parameters 'commands=["ansible --version","which ansible","python3 -c \"import boto3; print(f'"'"'boto3: {boto3.__version__}'"'"')\"","python3 -c \"import botocore; print(f'"'"'botocore: {botocore.__version__}'"'"')\""]' \
            --comment "Verify Ansible installation" \
            --query "Command.CommandId" \
            --output text)
          
          echo "Verify Command ID: $VERIFY_CMD"
          sleep 10
          
          VERIFY_OUTPUT=$(aws ssm get-command-invocation \
            --command-id "$VERIFY_CMD" \
            --instance-id "$INSTANCE_ID" \
            --query 'StandardOutputContent' \
            --output text)
          
          echo "✓ Ansible verification:"
          echo "$VERIFY_OUTPUT"

      - name: Bootstrap Summary
        run: |
          echo "### Ansible Controller Bootstrap Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ **Status:** Bootstrap Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Instance ID:** \`${{ env.INSTANCE_ID }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Installed Components:**" >> $GITHUB_STEP_SUMMARY
          echo "- Ansible" >> $GITHUB_STEP_SUMMARY
          echo "- boto3 & botocore (for AWS SSM inventory)" >> $GITHUB_STEP_SUMMARY
          echo "- SSM inventory configuration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Configuration Files:**" >> $GITHUB_STEP_SUMMARY
          echo "- Inventory: \`/home/ubuntu/ansible/inventory/ssm_inventory.aws_ec2.yml\`" >> $GITHUB_STEP_SUMMARY
          echo "- Config: \`/home/ubuntu/ansible/ansible.cfg\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next Steps:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Manually trigger 'ECR Build and Push' workflow" >> $GITHUB_STEP_SUMMARY
          echo "2. 'Deploy WebApp' will auto-trigger on successful build" >> $GITHUB_STEP_SUMMARY
