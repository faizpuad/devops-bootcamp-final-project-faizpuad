name: Deploy WebApp to Web Server

on:
  workflow_run:
    workflows: ["ECR Build and Push"]
    types:
      - completed

env:
  AWS_REGION: us-east-1

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get Ansible Controller Instance ID
        id: controller
        run: |
          CONTROLLER_ID=$(aws ssm get-parameter \
            --name "/devops/controller/instance-id" \
            --query "Parameter.Value" \
            --output text)
          echo "CONTROLLER_ID=$CONTROLLER_ID" >> $GITHUB_ENV
          echo "Ansible Controller: $CONTROLLER_ID"

      - name: Get AWS Account ID
        run: |
          AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          echo "AWS_ACCOUNT_ID=$AWS_ACCOUNT_ID" >> $GITHUB_ENV
          echo "AWS Account ID: $AWS_ACCOUNT_ID"

      - name: Upload Ansible playbooks and scripts to S3
        run: |
          BUCKET="${{ vars.TF_STATE_BUCKET }}"
          
          # Upload Ansible playbooks
          aws s3 sync ansible/playbooks/ s3://${BUCKET}/ansible/playbooks/
          
          # Upload bash scripts
          aws s3 sync bash/ s3://${BUCKET}/scripts/
          
          # Upload docker-compose file
          aws s3 cp docker/webapp/docker-compose.yml s3://${BUCKET}/webapp/docker-compose.yml
          
          echo "✅ Files uploaded to S3"

      - name: Prepare Ansible Controller
        run: |
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "${{ env.CONTROLLER_ID }}" \
            --document-name "AWS-RunShellScript" \
            --parameters 'commands=["#!/bin/bash","set -e","mkdir -p /home/ssm-user/ansible/playbooks","mkdir -p /home/ssm-user/scripts","cd /home/ssm-user","aws s3 sync s3://${{ vars.TF_STATE_BUCKET }}/ansible/playbooks/ ansible/playbooks/","aws s3 sync s3://${{ vars.TF_STATE_BUCKET }}/scripts/ scripts/","chmod +x scripts/*.sh","chown -R ssm-user: /home/ssm-user/ansible","chown -R ssm-user: /home/ssm-user/scripts","export TF_STATE_BUCKET=${{ vars.TF_STATE_BUCKET }}","export AWS_ACCOUNT_ID=${{ env.AWS_ACCOUNT_ID }}","echo TF_STATE_BUCKET=${{ vars.TF_STATE_BUCKET }} >> /home/ssm-user/.bashrc","echo AWS_ACCOUNT_ID=${{ env.AWS_ACCOUNT_ID }} >> /home/ssm-user/.bashrc","echo Ansible files downloaded"]' \
            --timeout-seconds 300 \
            --comment "Download Ansible files from S3" \
            --query "Command.CommandId" \
            --output text)
          
          echo "Command ID: $COMMAND_ID"
          
          # Wait for download to complete
          for i in {1..30}; do
            STATUS=$(aws ssm get-command-invocation \
              --command-id "$COMMAND_ID" \
              --instance-id "${{ env.CONTROLLER_ID }}" \
              --query 'Status' \
              --output text 2>/dev/null || echo "Pending")
            
            echo "Check $i/30 - Status: $STATUS"
            
            if [ "$STATUS" = "Success" ]; then
              echo "✅ Files downloaded to Ansible Controller"
              break
            elif [ "$STATUS" = "Failed" ]; then
              echo "❌ Failed to download files"
              aws ssm get-command-invocation \
                --command-id "$COMMAND_ID" \
                --instance-id "${{ env.CONTROLLER_ID }}"
              exit 1
            fi
            
            sleep 10
          done

      - name: Run Ansible Playbook - Install Docker
        run: |
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "${{ env.CONTROLLER_ID }}" \
            --document-name "AWS-RunShellScript" \
            --parameters 'commands=["#!/bin/bash","set -e","cd /home/ssm-user/ansible","export TF_STATE_BUCKET=${{ vars.TF_STATE_BUCKET }}","export AWS_ACCOUNT_ID=${{ env.AWS_ACCOUNT_ID }}","echo Running install-docker playbook...","ansible-playbook -i inventory/ssm_inventory.aws_ec2.yml playbooks/install-docker.yml -v --become"]' \
            --timeout-seconds 600 \
            --comment "Install Docker on web server" \
            --query "Command.CommandId" \
            --output text)
          
          echo "Command ID: $COMMAND_ID"
          
          # Wait for playbook execution
          for i in {1..60}; do
            STATUS=$(aws ssm get-command-invocation \
              --command-id "$COMMAND_ID" \
              --instance-id "${{ env.CONTROLLER_ID }}" \
              --query 'Status' \
              --output text 2>/dev/null || echo "Pending")
            
            echo "Check $i/60 - Status: $STATUS"
            
            if [ "$STATUS" = "Success" ]; then
              echo "✅ Docker installation completed"
              aws ssm get-command-invocation \
                --command-id "$COMMAND_ID" \
                --instance-id "${{ env.CONTROLLER_ID }}" \
                --query 'StandardOutputContent' \
                --output text
              break
            elif [ "$STATUS" = "Failed" ]; then
              echo "❌ Docker installation failed"
              aws ssm get-command-invocation \
                --command-id "$COMMAND_ID" \
                --instance-id "${{ env.CONTROLLER_ID }}" \
                --query '[StandardOutputContent,StandardErrorContent]' \
                --output text
              exit 1
            fi
            
            sleep 10
          done

      - name: Run Ansible Playbook - Deploy WebApp
        run: |
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "${{ env.CONTROLLER_ID }}" \
            --document-name "AWS-RunShellScript" \
            --parameters 'commands=["#!/bin/bash","set -e","cd /home/ssm-user/ansible","export TF_STATE_BUCKET=${{ vars.TF_STATE_BUCKET }}","export AWS_ACCOUNT_ID=${{ env.AWS_ACCOUNT_ID }}","echo Running deploy-webapp playbook...","ansible-playbook -i inventory/ssm_inventory.aws_ec2.yml playbooks/deploy-webapp.yml -v --become"]' \
            --timeout-seconds 600 \
            --comment "Deploy webapp from ECR" \
            --query "Command.CommandId" \
            --output text)
          
          echo "Command ID: $COMMAND_ID"
          
          # Wait for playbook execution
          for i in {1..60}; do
            STATUS=$(aws ssm get-command-invocation \
              --command-id "$COMMAND_ID" \
              --instance-id "${{ env.CONTROLLER_ID }}" \
              --query 'Status' \
              --output text 2>/dev/null || echo "Pending")
            
            echo "Check $i/60 - Status: $STATUS"
            
            if [ "$STATUS" = "Success" ]; then
              echo "✅ WebApp deployment completed"
              aws ssm get-command-invocation \
                --command-id "$COMMAND_ID" \
                --instance-id "${{ env.CONTROLLER_ID }}" \
                --query 'StandardOutputContent' \
                --output text
              break
            elif [ "$STATUS" = "Failed" ]; then
              echo "❌ WebApp deployment failed"
              aws ssm get-command-invocation \
                --command-id "$COMMAND_ID" \
                --instance-id "${{ env.CONTROLLER_ID }}" \
                --query '[StandardOutputContent,StandardErrorContent]' \
                --output text
              exit 1
            fi
            
            sleep 10
          done

      - name: Deployment Summary
        run: |
          echo "### Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ **Status:** Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Ansible Controller:** \`${{ env.CONTROLLER_ID }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Playbooks Executed:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Install Docker on web server" >> $GITHUB_STEP_SUMMARY
          echo "2. Deploy WebApp from ECR" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Key Changes:**" >> $GITHUB_STEP_SUMMARY
          echo "- Docker installed on web server instance (not controller)" >> $GITHUB_STEP_SUMMARY
          echo "- Firewall configured (UFW ports 80, 443)" >> $GITHUB_STEP_SUMMARY
          echo "- Docker Compose downloaded and configured" >> $GITHUB_STEP_SUMMARY
          echo "- Container pulled from ECR and started" >> $GITHUB_STEP_SUMMARY