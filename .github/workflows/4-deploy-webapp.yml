name: Deploy WebApp

on:
  workflow_run:
    workflows: ["ECR Build and Push"]
    types:
      - completed

env:
  AWS_REGION: us-east-1

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get Controller Instance ID
        run: |
          CONTROLLER_ID=$(aws ssm get-parameter \
            --name "/devops/controller/instance-id" \
            --query "Parameter.Value" \
            --output text)
          echo "CONTROLLER_ID=$CONTROLLER_ID" >> $GITHUB_ENV
          echo "Ansible Controller: $CONTROLLER_ID"

      - name: Update Repository on Controller
        run: |
          UPDATE_CMD=$(aws ssm send-command \
            --instance-ids "$CONTROLLER_ID" \
            --document-name "AWS-RunShellScript" \
            --parameters 'commands=["#!/bin/bash","cd /home/ssm-user/devops-bootcamp","git pull","echo ✓ Repository updated"]' \
            --timeout-seconds 60 \
            --query "Command.CommandId" \
            --output text)
          
          sleep 10
          echo "✓ Repository updated"

      - name: Run Install Docker Playbook
        run: |
          DOCKER_CMD=$(aws ssm send-command \
            --instance-ids "$CONTROLLER_ID" \
            --document-name "AWS-RunShellScript" \
            --parameters 'commands=["#!/bin/bash","cd /home/ssm-user/devops-bootcamp/ansible","ansible-playbook -i inventory/ssm_inventory.aws_ec2.yml playbooks/install-docker.yml"]' \
            --timeout-seconds 600 \
            --query "Command.CommandId" \
            --output text)
          
          echo "Docker Install Command ID: $DOCKER_CMD"
          
          for i in {1..60}; do
            STATUS=$(aws ssm get-command-invocation \
              --command-id "$DOCKER_CMD" \
              --instance-id "$CONTROLLER_ID" \
              --query 'Status' \
              --output text 2>/dev/null || echo "Pending")
            
            echo "Check $i/60 - Status: $STATUS"
            
            if [ "$STATUS" = "Success" ]; then
              echo "✓ Docker installed"
              aws ssm get-command-invocation \
                --command-id "$DOCKER_CMD" \
                --instance-id "$CONTROLLER_ID" \
                --query 'StandardOutputContent' \
                --output text
              break
            elif [ "$STATUS" = "Failed" ]; then
              echo "✗ Docker installation failed"
              aws ssm get-command-invocation \
                --command-id "$DOCKER_CMD" \
                --instance-id "$CONTROLLER_ID"
              exit 1
            fi
            sleep 10
          done

      - name: Run Deploy WebApp Playbook
        run: |
          DEPLOY_CMD=$(aws ssm send-command \
            --instance-ids "$CONTROLLER_ID" \
            --document-name "AWS-RunShellScript" \
            --parameters 'commands=["#!/bin/bash","cd /home/ssm-user/devops-bootcamp/ansible","ansible-playbook -i inventory/ssm_inventory.aws_ec2.yml playbooks/deploy-webapp.yml"]' \
            --timeout-seconds 600 \
            --query "Command.CommandId" \
            --output text)
          
          echo "Deploy Command ID: $DEPLOY_CMD"
          
          for i in {1..60}; do
            STATUS=$(aws ssm get-command-invocation \
              --command-id "$DEPLOY_CMD" \
              --instance-id "$CONTROLLER_ID" \
              --query 'Status' \
              --output text 2>/dev/null || echo "Pending")
            
            echo "Check $i/60 - Status: $STATUS"
            
            if [ "$STATUS" = "Success" ]; then
              echo "✓ WebApp deployed"
              aws ssm get-command-invocation \
                --command-id "$DEPLOY_CMD" \
                --instance-id "$CONTROLLER_ID" \
                --query 'StandardOutputContent' \
                --output text
              break
            elif [ "$STATUS" = "Failed" ]; then
              echo "✗ Deployment failed"
              aws ssm get-command-invocation \
                --command-id "$DEPLOY_CMD" \
                --instance-id "$CONTROLLER_ID"
              exit 1
            fi
            sleep 10
          done

      - name: Deployment Summary
        run: |
          echo "### Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ **Status:** Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Ansible Controller:** \`${{ env.CONTROLLER_ID }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Playbooks Executed:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Install Docker on web server" >> $GITHUB_STEP_SUMMARY
          echo "2. Deploy WebApp from ECR" >> $GITHUB_STEP_SUMMARY